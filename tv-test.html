<style>
  /* pewne wysokości i odporność na flex/overflow */
  .tv-row { display: grid; gap: 16px; }
  .tv-box { height: 420px; min-height: 320px; border-radius: 8px; overflow: hidden; }
  @media (max-width: 900px){ .tv-box { height: 360px; } }
</style>

<div class="tv-row">
  <div id="tv_trend" class="tv-box"></div>
  <div id="tv_entry" class="tv-box"></div>
</div>

<script>
(function(){
  const TV_SRC = "https://s3.tradingview.com/tv.js";
  const charts = [
    { id: "tv_trend", symbol: "BINANCE:BTCUSDT", interval: "W"  }, // Trend (W1)
    { id: "tv_entry", symbol: "BINANCE:BTCUSDT", interval: "240"}  // Wejście (H4)
  ];

  // 1) Załaduj tv.js tylko raz
  function loadTV(cb){
    if (window.TradingView) return cb();
    if (document.querySelector('script[data-tvjs]')) {
      // ktoś już ładuje – poczekaj
      const iv = setInterval(() => {
        if (window.TradingView){ clearInterval(iv); cb(); }
      }, 50);
      return;
    }
    const s = document.createElement('script');
    s.src = TV_SRC; s.async = true; s.defer = true; s.setAttribute('data-tvjs','1');
    s.onload = cb;
    document.head.appendChild(s);
  }

  // 2) Bezpieczne tworzenie pojedynczego wykresu
  function makeChart({id, symbol, interval}){
    const el = document.getElementById(id);
    if (!el) return console.warn("[TV] Brak kontenera:", id);

    // Kontener musi mieć realną wysokość
    const h = el.getBoundingClientRect().height;
    if (!h || h < 50) {
      // spróbuj po krótkiej chwili (np. gdy karta staje się widoczna)
      return setTimeout(() => makeChart({id, symbol, interval}), 120);
    }

    // Fallback na wypadek pustego symbolu
    if (!symbol || typeof symbol !== "string") symbol = "BINANCE:BTCUSDT";

    new TradingView.widget({
      container_id: id,
      symbol,
      interval,             // "W" dla tyg., "240" = H4
      theme: "dark",
      style: "1",
      locale: "pl",
      autosize: true,
      allow_symbol_change: true,
      backgroundColor: "rgba(0,0,0,1)"
    });
  }

  // 3) Start po DOM i po tv.js
  function initAll(){
    loadTV(() => {
      charts.forEach(makeChart);
    });
  }

  if (document.readyState === "loading")
    document.addEventListener("DOMContentLoaded", initAll);
  else
    initAll();

})();
</script>
