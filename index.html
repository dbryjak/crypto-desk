<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daniel – Crypto Desk</title>
  <meta name="description" content="Prywatny kokpit: strategia hybrydowa, wykres TradingView, portfel + dziennik transakcji (localStorage)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0e14;--panel:#121826;--muted:#9aa4b2;--text:#e5e7eb;--accent:#22d3ee;--accent2:#8b5cf6;--bad:#fca5a5;--ok:#86efac}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0e14 0%, #0f1524 100%);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
    .wrap{max-width:1300px;margin:0 auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:38px;height:38px;border-radius:10px;background:radial-gradient(60% 60% at 50% 50%, var(--accent) 0%, var(--accent2) 100%);box-shadow:0 0 20px rgba(34,211,238,.35)}
    h1{font-size:22px;margin:0;font-weight:800;letter-spacing:.2px}
    .grid{display:grid;gap:16px}
    @media(min-width:940px){.grid-3{grid-template-columns:repeat(3,1fr)}}
    .card{background:rgba(255,255,255,.04);backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .card h2{font-size:16px;margin:0 0 8px;font-weight:800}
    .card h3{font-size:14px;margin:10px 0 6px;font-weight:800;color:#c7d2fe}
    .muted{color:var(--muted);font-size:13px}
    .kicker{font-size:12px;color:#a5f3fc;text-transform:uppercase;letter-spacing:.12em}
    .list{margin:8px 0 0;padding-left:18px}
    .list li{margin:6px 0}
    .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:6px 10px;font-size:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,select,button,textarea{background:#0c1220;border:1px solid rgba(255,255,255,.12);color:var(--text);border-radius:10px;padding:8px 10px;font-size:14px}
    button{cursor:pointer}
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px;text-align:left;font-size:13px}
    .right{text-align:right}
    .green{color:var(--ok)}
    .red{color:var(--bad)}
    .footer{margin:22px 0 8px;color:var(--muted);font-size:12px}
    .btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none}
    .status{display:inline-block;border-radius:8px;padding:4px 8px;font-size:12px;border:1px solid rgba(255,255,255,.15)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><div>
        <h1>Daniel – Crypto Desk</h1>
        <div class="muted">Twój prywatny kokpit: strategia • wykres • portfel • dziennik • (zapamiętywanie ustawień działa automatycznie)</div>
      </div></div>
      <div class="row">
        <button class="pill" id="installPWA" title="Dodaj na ekran główny">➕ Dodaj do telefonu</button>
        <a class="pill" href="#" id="exportAll">⬇️ Eksport danych</a>
        <label class="pill" style="gap:4px">⬆️ Import <input type="file" id="importAll" accept="application/json" style="display:none"></label>
      </div>
    </header>

    <!-- WYKRESY – 2 okna obok siebie (Multi‑TF) -->
    <section class="card">
      <div class="kicker">Wykresy</div>
      <h2>TradingView – widok multi‑TF (W1 + H4)</h2>
      <div class="row" style="margin-bottom:8px">
        <select id="tvSymbol">
          <option value="CRYPTO:BTCUSD">BTCUSD</option>
          <option value="CRYPTO:ETHUSD">ETHUSD</option>
          <option value="BINANCE:BTCUSDT">BTC/USDT (Binance)</option>
          <option value="BINANCE:ETHUSDT">ETH/USDT (Binance)</option>
          <option value="BINANCE:SOLUSDT">SOL/USDT</option>
        </select>
        <button id="reloadBoth">Załaduj / Odśwież oba</button>
        <span id="tvStatus" class="status muted">TV: niezaładowany</span>
      </div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
        <div>
          <div class="row" style="justify-content:space-between"><strong>Trend (W1)</strong>
            <label>Interwał: <select id="tfLeft"><option value="W" selected>W1</option><option value="D">D1</option></select></label>
          </div>
          <iframe id="tvLeft" style="width:100%;height:420px;margin-top:6px;border:none"></iframe>
          <div id="leftFallback" class="muted" style="display:none;margin-top:6px"></div>
          <div class="muted">W1: ustaw EMA50/EMA200 (trend).</div>
        </div>
        <div>
          <div class="row" style="justify-content:space-between"><strong>Wejście (H4)</strong>
            <label>Interwał: <select id="tfRight"><option value="240" selected>H4</option><option value="60">H1</option><option value="120">H2</option></select></label>
          </div>
          <iframe id="tvRight" style="width:100%;height:420px;margin-top:6px;border:none"></iframe>
          <div id="rightFallback" class="muted" style="display:none;margin-top:6px"></div>
          <div class="muted">H4: rysuj Fibo 38–62% + poziomy S/R, obserwuj RSI.</div>
        </div>
      </div>
      <h3>Sygnały (beta – z CoinGecko, bez kluczy)</h3>
      <div class="row">
        <label><input type="checkbox" id="sgRsiBounce" checked> RSI (H4) &lt;30 i zawraca ↑</label>
        <label><input type="checkbox" id="sgCross50" checked> RSI (H4) przecina ↑ 50</label>
        <label><input type="checkbox" id="sgTrend" checked> Filtr trendu: cena (D1) nad EMA50 &gt; EMA200</label>
        <button id="runScan">Skanuj teraz</button>
        <button id="testBeep">Test dźwięku</button>
        <span id="sigStatus" class="status muted">Sygnały: gotowe</span>
      </div>
      <div class="row" style="margin-top:6px">
        <label>Auto‑scan: 
          <select id="scanEvery">
            <option value="0">OFF</option>
            <option value="5">co 5 min</option>
            <option value="15">co 15 min</option>
            <option value="30" selected>co 30 min</option>
            <option value="60">co 1 h</option>
            <option value="240">co 4 h</option>
          </select>
        </label>
        <span id="scanInfo" class="muted">Auto‑scan: OFF</span>
      </div>
      <div id="sigLog" class="muted" style="margin-top:6px;white-space:pre-wrap"></div>
    </section>

    <!-- DRUGI RZĄD: trzy karty obok siebie -->
    <div class="grid grid-3">
      <!-- PORTFEL -->
      <section class="card">
        <div class="kicker">Portfel</div>
        <h2>Tracker (localStorage + ceny z CoinGecko)</h2>
        <div class="row">
          <input id="sym" placeholder="symbol (btc, eth, sol)" />
          <input id="qty" type="number" step="any" placeholder="ilość" />
          <input id="cost" type="number" step="any" placeholder="koszt bazowy (USD)" />
          <button class="btn" id="addPos">Dodaj</button>
        </div>
        <table id="pfTable" style="margin-top:10px">
          <thead><tr><th>Krypto</th><th class="right">Ilość</th><th class="right">Cena</th><th class="right">Wartość</th><th class="right">Koszt</th><th class="right">P/L</th><th></th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th colspan="3">Razem</th><th class="right" id="sumVal">–</th><th class="right" id="sumCost">–</th><th class="right" id="sumPL">–</th><th></th></tr></tfoot>
        </table>
        <div class="muted">Dane portfela są zapisywane tylko w Twojej przeglądarce. Ceny pobierane z publicznego API CoinGecko.</div>
      </section>

      <!-- DZIENNIK -->
      <section class="card">
        <div class="kicker">Dziennik</div>
        <h2>Transakcje</h2>
        <div class="row">
          <input id="jDate" type="date" />
          <input id="jSetup" placeholder="Setup" />
          <input id="jEntry" placeholder="Wejście / SL / TP" />
          <input id="jReason" placeholder="Powód wejścia" />
          <input id="jPlan" placeholder="Plan zarządzania" />
          <input id="jResult" placeholder="Wynik (+/- R)" />
          <input id="jLesson" placeholder="Lekcja" />
          <button id="addLog" class="btn">Dodaj wpis</button>
        </div>
        <table id="logTable" style="margin-top:10px">
          <thead><tr><th>Data</th><th>Setup</th><th>Wejście/SL/TP</th><th>Powód</th><th>Plan</th><th>Wynik</th><th>Lekcja</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row" style="margin-top:8px">
          <button id="exportCSV">Eksport CSV</button>
          <button id="clearLog">Wyczyść dziennik</button>
        </div>
      </section>

      <!-- STRATEGIA -->
      <section class="card">
        <div class="kicker">Strategia</div>
        <h2>Ścianka w garażu – skrót hybrydy</h2>
        <ol class="list">
          <li><b>Filtr (W1):</b> cena > EMA50 > EMA200 i RSI>50.</li>
          <li><b>Miejsca (D1):</b> Fibo 38–62%, EMA50/200, poziomy S/R.</li>
          <li><b>Sygnał (H4):</b> RSI<30 odbija + świeca odwrócenia.</li>
          <li><b>SL:</b> pod dołkiem lub 1,5×ATR; R=0,5–1%.</li>
          <li><b>TP1 1,5R</b> (30–50% + BE); <b>TP2 3R</b> / poprzedni szczyt; reszta trail po EMA20 D1.</li>
          <li><b>Alerty:</b> RSI H4↑30; cena w boxie Fibo; D1≈EMA200; RSI D1>70.</li>
        </ol>
      </section>
    </div>

    <div class="footer">© Daniel – prywatny kokpit. Ustawienia symbolu i interwału są automatycznie zapisywane w localStorage i odtwarzane po restarcie.</div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    const TV_SYMBOL_KEY='tv.symbol.v1';
    const TF_LEFT_KEY='tv.tf.left';
    const TF_RIGHT_KEY='tv.tf.right';

    function saveTVPrefs(){ try{ localStorage.setItem(TV_SYMBOL_KEY,$('#tvSymbol').value); localStorage.setItem(TF_LEFT_KEY,$('#tfLeft').value); localStorage.setItem(TF_RIGHT_KEY,$('#tfRight').value);}catch(e){} }
    function applySavedTVPrefs(){ try{ const s=localStorage.getItem(TV_SYMBOL_KEY); const l=localStorage.getItem(TF_LEFT_KEY); const r=localStorage.getItem(TF_RIGHT_KEY); if(s) $('#tvSymbol').value=s; if(l) $('#tfLeft').value=l; if(r) $('#tfRight').value=r;}catch(e){} }

    function tvUrlWidget(symbol, interval){
      const params = new URLSearchParams({
        frameElementId:'tvEmbed', symbol, interval,
        hidesidetoolbar:'0', hidetoptoolbar:'0', symboledit:'1',
        withdateranges:'1', toolbarbg:'f1f3f6', studies:'[]',
        theme:'dark', style:'1', timezone:'Etc/UTC', allow_symbol_change:'1', hideideas:'1', locale:'pl',
        uid: Date.now()+''
      });
      return 'https://s.tradingview.com/widgetembed/?' + params.toString();
    }
    function tvUrlAdvanced(symbol, interval){
      const cfg = { symbol, interval, hide_top_toolbar:false, hide_side_toolbar:false, allow_symbol_change:true, locale:'pl', theme:'dark', autosize:true };
      return 'https://s.tradingview.com/embed-widget/advanced-chart/?locale=pl#' + encodeURIComponent(JSON.stringify(cfg));
    };
      return 'https://s.tradingview.com/embed-widget/advanced-chart/?locale=pl#' + encodeURIComponent(JSON.stringify(cfg));
    }&interval=${encodeURIComponent(interval)}&hidesidetoolbar=1&hidetoptoolbar=1&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=[]&theme=dark&style=1&timezone=Etc%2FUTC&withdateranges=1&allow_symbol_change=1&hideideas=1`; }

    function loadInto(el, urlPrimary, urlSecondary, fbEl, label){
      let loaded=false; el.onload=()=>{ loaded=true; if(fbEl) fbEl.style.display='none'; };
      el.src=urlPrimary;
      setTimeout(()=>{ if(!loaded){ el.src=urlSecondary; } }, 3000);
      setTimeout(()=>{ if(!loaded && fbEl){ fbEl.style.display='block'; fbEl.innerHTML = `Nie udało się osadzić. <a href="${urlSecondary}" target="_blank" rel="noopener">Otwórz ${label}</a>.`; } }, 6000);
    }
    function loadBoth(){
      saveTVPrefs();
      const s=$('#tvSymbol').value; const l=$('#tfLeft').value, r=$('#tfRight').value;
      const l1=tvUrlWidget(s,l), l2=tvUrlAdvanced(s,l);
      const r1=tvUrlWidget(s,r), r2=tvUrlAdvanced(s,r);
      loadInto($('#tvLeft'), l1, l2, $('#leftFallback'), `Trend (${l})`);
      loadInto($('#tvRight'), r1, r2, $('#rightFallback'), `Wejście (${r})`);
      $('#tvStatus').textContent='TV: OK'; $('#tvStatus').style.color='var(--ok)';
    }" target="_blank" rel="noopener">Trend (${l})</a>`;
        rf.innerHTML = `Jeśli wykres się nie wyświetla, otwórz: <a href="${rUrl}" target="_blank" rel="noopener">Wejście (${r})</a>`;
        lf.style.display='block'; rf.style.display='block';
      }, 4000);
    }

    $('#reloadBoth').addEventListener('click', loadBoth);
    $('#tvSymbol').addEventListener('change', loadBoth);
    $('#tfLeft').addEventListener('change', loadBoth);
    $('#tfRight').addEventListener('change', loadBoth);
    window.addEventListener('load', ()=>{ applySavedTVPrefs(); loadBoth(); applySavedScan(); });

    // ===== Sygnały (beta) =====
    const CG_MAP={ 'CRYPTO:BTCUSD':'bitcoin', 'BINANCE:BTCUSDT':'bitcoin', 'CRYPTO:ETHUSD':'ethereum', 'BINANCE:ETHUSDT':'ethereum', 'BINANCE:SOLUSDT':'solana' };
    function cgId(){ const s=$('#tvSymbol').value; return CG_MAP[s]||'bitcoin'; }

    function rsi(values, period=14){ if(values.length<period+1) return null; const gains=[]; const losses=[]; for(let i=1;i<values.length;i++){ const ch=values[i]-values[i-1]; gains.push(Math.max(ch,0)); losses.push(Math.max(-ch,0)); }
      let avgGain = gains.slice(0,period).reduce((a,b)=>a+b,0)/period; let avgLoss = losses.slice(0,period).reduce((a,b)=>a+b,0)/period; for(let i=period;i<gains.length;i++){ avgGain=(avgGain*(period-1)+gains[i])/period; avgLoss=(avgLoss*(period-1)+losses[i])/period; }
      const rs = avgLoss===0? 100 : avgGain/avgLoss; const rsi = 100 - (100/(1+rs)); return rsi; }

    function ema(values, period){ const k=2/(period+1); let emaVal=values[0]; for(let i=1;i<values.length;i++){ emaVal = values[i]*k + emaVal*(1-k); } return emaVal; }

    async function fetchH4Prices(id){ const url=`https://api.coingecko.com/api/v3/coins/${id}/ohlc?vs_currency=usd&days=7`; const r=await fetch(url); const arr=await r.json(); return arr.map(x=>x[4]); }
    async function fetchDailyCloses(id){ const url=`https://api.coingecko.com/api/v3/coins/${id}/market_chart?vs_currency=usd&days=400&interval=daily`; const r=await fetch(url); const j=await r.json(); return j.prices.map(x=>x[1]); }

    function beep(){ try{ const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain(); o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.3); setTimeout(()=>o.stop(), 320); }catch(e){} }

    async function runScan(){ const out=[]; const id=cgId(); $('#sigStatus').textContent='Skanuję…'; try{
        const h4=await fetchH4Prices(id); const last=h4[h4.length-1];
        const rsiVal=rsi(h4,14);
        let rsiBounce=false, rsiCross50=false;
        if($('#sgRsiBounce').checked){ rsiBounce = rsiVal!==null && rsiVal>30 && rsi(h4.slice(0,-1),14)<30; }
        if($('#sgCross50').checked){ const rPrev = rsi(h4.slice(0,-1),14); rsiCross50 = rPrev!==null && rPrev<50 && rsiVal>=50; }
        out.push(`RSI(H4): ${rsiVal?rsiVal.toFixed(2):'n/a'}  Bounce<30: ${rsiBounce?'TAK':'nie'}  Cross↑50: ${rsiCross50?'TAK':'nie'}`);
        let trendOk=true; if($('#sgTrend').checked){ const d=await fetchDailyCloses(id); const ema50=ema(d.slice(-260),50); const ema200=ema(d.slice(-260),200); const close=d[d.length-1]; trendOk = close>ema50 && ema50>ema200; out.push(`Trend(D1): close ${close.toFixed(2)} | EMA50 ${ema50.toFixed(2)} | EMA200 ${ema200.toFixed(2)} → ${trendOk?'OK':'NIE'}`); }
        const fire = (rsiBounce||rsiCross50) && trendOk; $('#sigStatus').textContent = fire? 'Sygnał: TAK' : 'Sygnał: brak'; $('#sigStatus').style.color = fire? 'var(--ok)':'var(--muted)'; if(fire) beep();
      }catch(e){ out.push('Błąd skanera: '+e.message); $('#sigStatus').textContent='Sygnały: błąd'; $('#sigStatus').style.color='var(--bad)'; }
      $('#sigLog').textContent = out.join('
'); }

    $('#runScan').onclick=runScan; $('#testBeep').onclick=beep;

    // ===== Auto‑scan =====
    const SCAN_EVERY_KEY='scan.every.v1';
    let scanTimer=null, tickTimer=null, nextAt=null, isScanning=false;

    function minutesToMs(m){ return m*60000; }
    function fmtTime(ts){ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    function setScanInfo(txt){ $('#scanInfo').textContent = txt; }

    function clearAutoScan(){ if(scanTimer){ clearTimeout(scanTimer); scanTimer=null;} if(tickTimer){ clearInterval(tickTimer); tickTimer=null;} nextAt=null; }

    function scheduleNext(){ const every = parseInt($('#scanEvery').value,10); if(!every){ clearAutoScan(); setScanInfo('Auto‑scan: OFF'); return; }
      const now=Date.now(); const ms=minutesToMs(every); nextAt = now + ms; setScanInfo(`Auto‑scan: co ${every} min • następny ≈ ${fmtTime(nextAt)}`);
      clearAutoScan();
      tickTimer = setInterval(()=>{ if(!nextAt) return; const mins=Math.max(0, Math.round((nextAt-Date.now())/60000)); $('#scanInfo').textContent = `Auto‑scan: co ${every} min • następny ≈ ${fmtTime(nextAt)} (${mins}m)`; }, 15000);
      scanTimer = setTimeout(async ()=>{ if(isScanning) return; isScanning=true; await runScan(); isScanning=false; scheduleNext(); }, ms);
    }

    function applySavedScan(){ try{ const v=localStorage.getItem(SCAN_EVERY_KEY); if(v){ $('#scanEvery').value=v; } scheduleNext(); }catch(e){} }

    $('#scanEvery').addEventListener('change', ()=>{ localStorage.setItem(SCAN_EVERY_KEY, $('#scanEvery').value); scheduleNext(); });

    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ clearAutoScan(); } else { scheduleNext(); } });

    // ===== Auto-scan co X minut =====
    let autoScanTimer=null;
    function setAutoScan(mins){ if(autoScanTimer) clearInterval(autoScanTimer); if(mins>0){ autoScanTimer=setInterval(runScan, mins*60000); } }

    // Dodaj selektor interwału w UI
    const sel=document.createElement('select');
    sel.innerHTML='<option value="0">Auto-scan: wył</option><option value="5">co 5 min</option><option value="15">co 15 min</option><option value="30">co 30 min</option><option value="60">co 1h</option><option value="240">co 4h</option>';
    sel.onchange=()=>setAutoScan(parseInt(sel.value));
    document.querySelector('.row').appendChild(sel);
