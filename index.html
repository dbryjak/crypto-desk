<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Daniel – Crypto Desk (v7)</title>
  <meta name="description" content="Kokpit: strategia, wykres TradingView (autostart + offline + retry), portfel + dziennik." />
  <style>
    :root{--bg:#0b0e14;--panel:#121826;--muted:#9aa4b2;--text:#e5e7eb;--ok:#86efac;--bad:#fca5a5}
    body{margin:0;background:var(--bg);font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto;color:var(--text)}
    .card{background:#121826;padding:12px;margin:10px;border-radius:10px}
    .status{padding:4px 8px;border:1px solid #2a3346;border-radius:8px;font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    select,button,input[type="checkbox"]{background:#0c1220;border:1px solid #2a3346;color:var(--text);border-radius:8px;padding:6px 10px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>TradingView</h2>
    <div class="row">
      <select id="tvSymbol">
        <option value="CRYPTO:BTCUSD">BTCUSD</option>
        <option value="CRYPTO:ETHUSD">ETHUSD</option>
        <option value="BINANCE:BTCUSDT">BTC/USDT (Binance)</option>
        <option value="BINANCE:ETHUSDT">ETH/USDT (Binance)</option>
        <option value="BINANCE:SOLUSDT">SOL/USDT</option>
        <option value="BINANCE:AVAXUSDT">AVAX/USDT</option>
        <option value="BINANCE:ADAUSDT">ADA/USDT</option>
        <option value="BINANCE:LTCUSDT">LTC/USDT</option>
        <option value="BINANCE:XRPUSDT">XRP/USDT</option>
      </select>
      <select id="tvInterval">
        <option value="5">5m</option>
        <option value="15">15m</option>
        <option value="60">H1</option>
        <option value="120">H2</option>
        <option value="240">H4</option>
        <option value="720">H12</option>
        <option value="D">D1</option>
        <option value="W">W1</option>
      </select>
      <label><input type="checkbox" id="tvAutostart"> Autostart</label>
      <label><input type="checkbox" id="tvOffline"> Tryb offline (blokuj TV)</label>
      <button id="reloadTV">Załaduj wykres</button>
      <button id="resetTV">Reset ustawień</button>
      <span id="tvStatus" class="status">TV: wstrzymany</span>
    </div>
    <div id="tvWidget" style="height:420px;margin-top:10px" class="muted">Kliknij „Załaduj wykres” lub włącz Autostart. W trybie offline wykres jest wyłączony.</div>
    <div class="muted" style="margin-top:8px">Jeśli przeglądarka pyta o dostęp do domen TradingView, wybierz „Zezwól zawsze”. Preferencje są zapisywane lokalnie. Auto‑retry: 1.5s → 3s → 6s.</div>
  </div>

  <script>
    const $ = s=>document.querySelector(s);
    let tv=null, tvReady=false, tvRetry=0;

    // --- Preferencje ---
    const TV_SYMBOL_KEY='tv.symbol.v1';
    const TV_INTERVAL_KEY='tv.interval.v1';
    const TV_AUTOSTART_KEY='tv.autostart.v1';
    const TV_OFFLINE_KEY='tv.offline.v1';

    function saveTVPrefs(){
      try{
        localStorage.setItem(TV_SYMBOL_KEY,$('#tvSymbol').value);
        localStorage.setItem(TV_INTERVAL_KEY,$('#tvInterval').value);
        localStorage.setItem(TV_AUTOSTART_KEY,$('#tvAutostart').checked?'1':'0');
        localStorage.setItem(TV_OFFLINE_KEY,$('#tvOffline').checked?'1':'0');
      }catch(e){}
    }
    function applyTVPrefs(){
      try{
        const s=localStorage.getItem(TV_SYMBOL_KEY);
        const i=localStorage.getItem(TV_INTERVAL_KEY);
        const a=localStorage.getItem(TV_AUTOSTART_KEY);
        const o=localStorage.getItem(TV_OFFLINE_KEY);
        if(s) $('#tvSymbol').value=s; if(i) $('#tvInterval').value=i;
        $('#tvAutostart').checked = a==='1';
        $('#tvOffline').checked = o==='1';
      }catch(e){}
    }

    function setTVStatus(text, ok){
      const el=$('#tvStatus'); el.textContent=text; el.style.color = ok? 'var(--ok)' : 'var(--bad)';
    }

    async function loadTVScript(){
      if(window.TradingView) return; // już w pamięci
      const urls=['https://s3.tradingview.com/tv.js','https://s.tradingview.com/tv.js'];
      let lastErr=null;
      for(const url of urls){
        try{
          await new Promise((resolve,reject)=>{ const s=document.createElement('script'); s.src=url; s.async=true; s.defer=true; s.onload=resolve; s.onerror=()=>reject(new Error('tv.js nie wczytany: '+url)); document.head.appendChild(s); });
          if(window.TradingView) return; // sukces
        }catch(e){ lastErr=e; }
      }
      if(!window.TradingView) throw lastErr || new Error('Nie udało się załadować tv.js');
    }

    function destroyTV(){
      try{ if(tv && typeof tv.remove==='function'){ tv.remove(); } }catch(e){}
      tv=null; tvReady=false;
      $('#tvWidget').innerHTML='';
    }

    async function initTV(){
      saveTVPrefs();
      if($('#tvOffline').checked){
        destroyTV();
        setTVStatus('TV: offline', true);
        $('#tvWidget').innerHTML='<div class="muted">Tryb offline: wykres wyłączony. Odznacz, aby załadować.</div>';
        return;
      }
      $('#tvWidget').innerHTML='<div class="muted">Ładuję wykres…</div>';
      try{
        await loadTVScript();
        destroyTV();
        tv = new TradingView.widget({
          container_id:'tvWidget', autosize:true,
          symbol: $('#tvSymbol').value, interval: $('#tvInterval').value,
          timezone:'Etc/UTC', theme:'dark', style:'1', locale:'pl', allow_symbol_change:true,
          studies:['RSI@tv-basicstudies','MAExp@tv-basicstudies','MAExp@tv-basicstudies']
        });
        tv.onChartReady(()=>{ tvReady=true; });
        setTVStatus('TV: OK'+(tvRetry?` (po próbie ${tvRetry+1})`:''), true);
        tvRetry=0;
      }catch(e){
        setTVStatus('TV: BŁĄD – ponawiam…', false);
        if(tvRetry<3){
          const wait = Math.pow(2,tvRetry)*1500; tvRetry++;
          setTimeout(initTV, wait);
        } else {
          $('#tvWidget').innerHTML='<div class="muted">Błąd: '+e.message+' — sprawdź połączenie lub zgodę dla domen TradingView. Kliknij „Załaduj wykres”, aby spróbować ponownie.</div>';
          tvRetry=0;
        }
      }
    }

    function updateTV(){
      saveTVPrefs();
      if(tv && tvReady && !$('#tvOffline').checked){
        try{ tv.chart().setSymbol($('#tvSymbol').value, ()=>{}); }catch(e){}
        try{ tv.chart().setResolution($('#tvInterval').value, ()=>{}); }catch(e){}
      } else {
        initTV();
      }
    }

    $('#reloadTV').onclick = ()=> initTV();
    $('#resetTV').onclick = ()=>{ localStorage.removeItem(TV_SYMBOL_KEY); localStorage.removeItem(TV_INTERVAL_KEY); localStorage.removeItem(TV_AUTOSTART_KEY); localStorage.removeItem(TV_OFFLINE_KEY); applyTVPrefs(); setTVStatus('TV: ustawienia zresetowane', true); };
    $('#tvSymbol').onchange = updateTV;
    $('#tvInterval').onchange = updateTV;
    $('#tvAutostart').onchange = ()=> saveTVPrefs();
    $('#tvOffline').onchange = ()=> initTV();

    window.addEventListener('load', ()=>{ applyTVPrefs(); if($('#tvAutostart').checked) initTV(); });
  </script>
</body>
</html>
